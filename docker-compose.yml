services:
  db:
    image: mysql:8.0
    container_name: ${DB_HOST}
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - everest-network

  admin:
    build:
      context: .
      dockerfile: apps/admin/Dockerfile
    container_name: everest_admin
    restart: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DATABASE_URL=mysql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:3306/${DB_NAME}
      - NODE_ENV=production
      - AUTH_SECRET=${AUTH_SECRET}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${ADMIN_URL}
      - AUTH_TRUST_HOST=true
    volumes:
      - shared_uploads:/app/apps/admin/public/uploads
    ports:
      - "3001:3001"
    networks:
      - everest-network
      - dokploy-network
    labels:
      - "traefik.enable=true"
      # HTTPS Router
      - "traefik.http.routers.everest-admin-secure.rule=Host(`admin.academy.pro-everest.com`)"
      - "traefik.http.routers.everest-admin-secure.entrypoints=websecure"
      - "traefik.http.routers.everest-admin-secure.tls=true"
      - "traefik.http.routers.everest-admin-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.everest-admin-secure.service=everest-admin-service"
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.everest-admin.rule=Host(`admin.academy.pro-everest.com`)"
      - "traefik.http.routers.everest-admin.entrypoints=web"
      - "traefik.http.routers.everest-admin.middlewares=redirect-to-https@file"
      # Service
      - "traefik.http.services.everest-admin-service.loadbalancer.server.port=3001"

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: everest_web
    restart: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DATABASE_URL=mysql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:3306/${DB_NAME}
      - NODE_ENV=production
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${WEB_URL}
      - AUTH_TRUST_HOST=true
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      # SMTP Configuration for OTP
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
    volumes:
      - shared_uploads:/app/apps/web/public/uploads
    ports:
      - "3000:3000"
    networks:
      - everest-network
      - dokploy-network
    labels:
      - "traefik.enable=true"
      # HTTPS Router
      - "traefik.http.routers.everest-web-secure.rule=Host(`academy.pro-everest.com`)"
      - "traefik.http.routers.everest-web-secure.entrypoints=websecure"
      - "traefik.http.routers.everest-web-secure.tls=true"
      - "traefik.http.routers.everest-web-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.everest-web-secure.service=everest-web-service"
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.everest-web.rule=Host(`academy.pro-everest.com`)"
      - "traefik.http.routers.everest-web.entrypoints=web"
      - "traefik.http.routers.everest-web.middlewares=redirect-to-https@file"
      # Service
      - "traefik.http.services.everest-web-service.loadbalancer.server.port=3000"

volumes:
  mysql_data:
    driver: local
  shared_uploads:
    driver: local

networks:
  everest-network:
    driver: bridge
  dokploy-network:
    external: true
